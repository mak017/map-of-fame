import{bo as M,aT as w,aV as L,aW as U,aU as T,aR as P,bJ as h,bK as v,bs as V,v as u,ar as A,a4 as O,bp as N,ab as j,ao as k}from"./index-09f9502f.js";import{c as F}from"./init-9beff97c.js";import{v as B}from"./datesUtils-5f8af51f.js";let z=null,c=null,d={},C=null,m=null,f=null;M.subscribe(t=>{d=t});w.subscribe(t=>{C=t});L.subscribe(t=>{m=t});U.subscribe(t=>{f=t});const D=({mapContainer:t,params:e,clearParams:o})=>{const s=t||z,r=C;let n=c||"";const a=s==null?void 0:s.getCenter(),i=a&&g(a.lat),E=a&&g(a.lng),b=s==null?void 0:s.getZoom();if(e||m||f){const l=e?e.artist:m,$=e?e.crew:f;n="",l&&(n=n.concat(`&artist=${l}`)),$&&(n=n.concat(`&crew=${$}`)),c=n}o==="all"&&(c=null,n=""),o&&Array.isArray(o)&&c&&(n=new URLSearchParams(c.substring(1)),o.forEach(l=>{n.delete(l)}),n=n.toString()?`&${n}`:"",c=n);const p=`/?coords=${i},${E}&zoom=${b}&year=${r}${n}`,I={zoom:b,center:a,year:r,params:e};decodeURIComponent(window.location.href).endsWith(p)||window.history.replaceStateNative(I,"map",p)},S=t=>{const e=t.get("year"),o=t.get("artist"),s=t.get("crew");return{year:e,artist:o,crew:s}},W=(t=window.location.search)=>{const e=new URLSearchParams(t);return S(e)},Z=t=>{const{year:e,artist:o,crew:s}=S(t),n=[...d.additionalYears?JSON.parse(d.additionalYears):[],T];e&&(o||s)&&n.push(P),e&&B(e,d.yearStart,n)&&w.set(e),o&&L.set(o),s&&U.set(s)},G=()=>{let t,e;const o=window.location.search;if(o){const s=new URLSearchParams(o);e=s.get("coords").split(",").map(n=>parseFloat(n,10)),t=+s.get("zoom"),Z(s)}return t||e?{zoom:t,center:e}:null},R=(t,e,o,s)=>{let r="";s&&Object.keys(s).forEach(i=>{r=r.concat(`&${i}=${s[i]}`)});const n=g(t.lat),a=g(t.lng);return`?coords=${n},${a}&zoom=${e}&year=${o}${r}`},J=(t,e,o,s)=>{const r={zoom:e,center:t,year:o,params:s};window.history.pushState(r,"map",R(t,e,o,s))},q=(t,e,o,s)=>{const{origin:r,pathname:n}=window.location,a=R(t,e,o,s);return`${r}${n}${a}`},x=(t,e)=>{const{origin:o}=window.location;return`${o}/registration?invite_code=${t}&from_user=${e}`},K=t=>{z=t},Y={getMapLocation:G,setup:K,update:D,set:J,getCustomUrl:q,getInviteUrl:x,getDataFromParams:S,getDataFromUrl:W},y=()=>fetch("https://ipinfo.io/json?token=f7826cd7c9e44b").then(t=>t.json()).then(t=>{const{loc:e}=t;return{center:e.split(",").map(o=>+o),zoom:11}}),H=async t=>{const e=!t&&Y.getMapLocation();if(e)return e;if(navigator.geolocation)try{const o=await new Promise((n,a)=>{navigator.geolocation.getCurrentPosition(n,a)}),{latitude:s,longitude:r}=o.coords;return{center:[+s,+r],zoom:v}}catch{return y()}return y()},_=t=>{const e=t.getBounds();return[e.getNorthWest(),e.getSouthEast()]},et=t=>{const e=_(t);if(A.set(e),!u(j)&&!u(k)){const o=u(w);F(o)}},ot=(t,e)=>{H(e).then(o=>{t.setView(o.center||h.coordinates,o.zoom||v)}).catch(()=>{t.setView(h.coordinates,h.zoom)}).finally(()=>{Y.setup(t),V.set(!0);const o=_(t),s=u(w);A.set(o),e||(O.set(!0),F(s||N()))})},g=t=>Math.round(t*1e5)/1e5;export{et as h,Y as p,ot as s};
